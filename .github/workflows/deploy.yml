---
name: "Deploy"

# yamllint disable-line rule:truthy
on:
  release:
    types:
      - published
  workflow_dispatch:

env:
  MODULE_NAME: ovoenergy

jobs:
  deploy:
    name: üöÄ Linux - Deploy Module
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: ‚§µÔ∏è Check out code from GitHub
        uses: actions/checkout@v5
        with:
          ref: "master"
          token: ${{ secrets.PUSH_TOKEN }}
      - name: üèó Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: "pip"
      - name: üèó Install build tooling
        run: |
          python -m pip install --upgrade setuptools wheel twine
      - name: üî¢ Get old version
        id: get-version-old
        run: |
          result=$(python script/get_version.py)
          echo "version=$result" >> $GITHUB_OUTPUT
      - name: üî¢ Set correct version - Development
        if: ${{ github.event_name != 'release' }}
        run: |
          python script/set_dev_version.py
      - name: üî¢ Set correct version - Release
        if: ${{ github.event_name == 'release' }}
        run: |
          python script/set_release_version.py
      - name: üî¢ Get current version
        id: get-version-current
        run: |
          result=$(python script/get_version.py)
          echo "version=$result" >> $GITHUB_OUTPUT
      - name: ‚§µÔ∏è Pull latest changes from GitHub
        run: |
          git pull --ff
      - name: üñä Commit
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        with:
          commit_message: |
            Bump ${{ env.MODULE_NAME }} version to ${{ steps.get-version-current.outputs.version }}
      - name: üèó Build distributions
        run: |
          python setup.py sdist bdist_wheel
      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
      - name: üî¢ Increment version - Development
        if: ${{ github.event_name != 'release' }}
        run: |
          python script/increment_version_dev.py
      - name: üî¢ Increment version - Release
        if: ${{ github.event_name == 'release' }}
        run: |
          python script/increment_version_release.py
      - name: üî¢ Get new version
        id: get-version-new
        run: |
          result=$(python script/get_version.py)
          echo "version=$result" >> $GITHUB_OUTPUT
      - name: ‚§µÔ∏è Pull latest changes from GitHub
        run: |
          git pull --ff
      - name: üñä Commit
        uses: stefanzweifel/git-auto-commit-action@v7.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TOKEN }}
        with:
          commit_message: |
            Bump ${{ env.MODULE_NAME }} version to ${{ steps.get-version-new.outputs.version }}
